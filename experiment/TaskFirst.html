<!DOCTYPE html>
<html>

<head>
    <!--create title shown in tab; not the same as header on webpage-->
    <title>PrimalsInteroception</title>

    <script src="utils/jspsych/jspsych.js"></script>

    <!--Load all necessary plugins stored in utils-->
    <script src="utils/jspsych/plugin-html-keyboard-response.js"></script>
    <script src="utils/jspsych/plugin-html-button-response.js"></script>
    <script src="utils/jspsych/plugin-fullscreen.js"></script>
    <script src="utils/jspsych/plugin-audio-button-response.js"></script>
    <script src="utils/jspsych/plugin-canvas-button-response.js"></script>
    <script src="utils/jspsych/plugin-preload.js"></script>
    <script src="utils/jspsych/multiple-slider.js"></script>
    <script src="utils/jspsych/plugin-survey-text.js"></script>
    <script src="utils/jspsych/extension-record-video.js"></script>
    <script src="utils/jspsych/plugin-initialize-camera.js"></script>
    <script src="parameters.js"></script>

    <!-- Applying default style here -->
    <link href="utils/jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        /* set canvas to be full screen */
        .jspsych-content {
            max-width: 100%;
        }

    </style>
</head>

<body></body>

<script>
    /* ----------------- Initialize experiment ----------------- */
    var timeline = []

    var extensions = []
    if (record_webcam == true) {
        extensions.push({ type: jsPsychExtensionRecordVideo })
    }

    var jsPsych = initJsPsych({
        extensions: extensions,
        // override_safe_mode: true,
        on_finish: function () {
            jsPsych.data.displayData()
            // jsPsych.data.displayData("json")
            jsPsych.data
                .get()
                .localSave(
                    "json",
                    `${jsPsych.data.get().values()[0]["participant_id"]
                    }_PI.json`
                )
        },
        show_progress_bar: true,
        message_progress_bar: ''
    })

    // Enter fullscreen mode
    timeline.push({
        type: jsPsychFullscreen,
        fullscreen_mode: true,
        delay_after: 0,
    })

    // Webcam initialization (can be activated in parameters.js)
    if (record_webcam == true) {
        timeline.push({
            type: jsPsychInitializeCamera,
        })
    }

    /* ----------------- Session Info ----------------- */
    // Participant information
    var participant_info = {
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: "Enter the participant's ID:",
                placeholder: "00",
                name: "Participant_ID",
            },
        ],
        data: {
            screen: "participant_info",
            version: version,
            date: new Date().toLocaleDateString("fr-FR"),
            time: new Date().toLocaleTimeString("fr-FR"),
        },
        on_finish: function () {
            jsPsych.data.addProperties({
                participant_id: jsPsych.data.get().last().values()[0][
                    "response"
                ]["Participant_ID"],
            })
        },
    }
    timeline.push(participant_info)

    // Define the question text
    var ageq =
        "Please enter your age in years:"
    var genderq =
        "Please enter your gender:"
    var raceq =
        "Please enter your ethnicity:"

    // Add the demografic questions
    timeline.push({
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: ageq,
                placeholder: "Enter your answer here",
                name: "age_response",
            },
        ],
        data: {
            screen: "agequestion",
        },
    })

    timeline.push({
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: genderq,
                placeholder: "Enter your answer here",
                name: "gender_response",
            },
        ],
        data: {
            screen: "genderquestion",
        },
    })

    timeline.push({
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: raceq,
                placeholder: "Enter your answer here",
                name: "race_response",
            },
        ],
        data: {
            screen: "racequestion",
        },
    })

    /* ----------------- Preloading ----------------- */
    // Preload audio variables
    var beep = ["utils/beep.mp3"]
    timeline.push({
        type: jsPsychPreload,
        auto_preload: true,
        audio: beep,
    })

    /* ----------------- Resting State ----------------- */
    // Instructions
    var instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus:
            "<p><b>Instructions</b></p>" +
            // Don't give exact time so that participants don't count
            "<p>A rest period of about 10 minutes is about to start.</p>" +
            "<p>Simply <b>relax</b> and remain seated quietly with your eyes closed. Please try <b>not to fall asleep</b>.</p> " +
            "<p>Once the resting period is over, you will hear a beep. You can then open your eyes and proceed.</p>" +
            "<p>Once you are ready, close your eyes. The rest period will shortly begin.</p>",
        choices: ["Continue"],
    }
    timeline.push(instructions)

    function create_marker(marker_position, color = "black") {
        const html = `<div id="marker" style="position: absolute; background-color: ${color};\
        left:${marker_position[0]}px; top:${marker_position[1]}px; \
        width:${marker_position[2]}px; height:${marker_position[3]}px";></div>`
        document.querySelector("body").insertAdjacentHTML("beforeend", html)
    }

    // Create blank grey screen just before rest period
    var buffer = {
        type: jsPsychHtmlKeyboardResponse,
        on_start: function () {
            document.body.style.backgroundColor = "#808080"
            document.body.style.cursor = "none"
            create_marker(marker_position, (color = "white"))
        },
        on_finish: function () {
            document.querySelector("#marker").remove()
        },
        stimulus: "",
        choices: ["s"],
        trial_duration: 1000, // 1 second
        css_classes: ["fixation"],
    }
    timeline.push(buffer)

    // Create blank grey screen for resting state
    var rest = {
        type: jsPsychHtmlKeyboardResponse,
        extensions: extensions,
        on_load: function () {
            create_marker(marker_position)
        },
        stimulus: "<p style='font-size:150px;'>+</p>",
        choices: ["s"],
        trial_duration: duratio * 60 * 1000,
        css_classes: ["fixation"],
        data: {
            screen: "resting",
            time_start: function () {
                return performance.now()
            },
        },
        on_finish: function (data) {
            document.querySelector("#marker").remove()
            data.duration =
                (performance.now() - data.time_start) / 1000 / 60
        },
    }
    timeline.push(rest)

    var audio_trigger = {
        type: jsPsychAudioButtonResponse,
        on_start: function () {
            document.body.style.backgroundColor = "#FFFFFF"
            document.body.style.cursor = "auto"
        },
        stimulus: beep,
        prompt: "<p>It's over! Please press continue.</p>",
        choices: ["Continue"],
    }
    timeline.push(audio_trigger)

    //questions
    var scale = ["Completely Disagree", "Completely Agree"]
    var questions = []
    for (const [index, element] of items.entries()) {
        questions.push({
            prompt: "<b>" + element + "</b>",
            name: dimensions[index],
            ticks: scale,
            required: questions_required,
        })
    }
    questions = jsPsych.randomization.shuffle(questions)

    // Add validation check items
    for (const [index, element] of check_items.entries()) {
        questions.push({
            prompt: "<b>" + element + "</b>",
            name: "Check_" + (index + 1),
            ticks: scale,
            required: questions_required,
        })
    }

    var questionnaire = {
        type: jsPsychMultipleSlider,
        questions: questions,
        randomize_question_order: false,
        preamble:
            "<p>We are interested in the potential feelings and thoughts you may have experienced during the resting period.</p>" +
            "<p>Please indicate the extent to which you agree with each statement.</p><br /><br/> ",
        require_movement: questions_required,
        slider_width: null,
        min: 0,
        max: 1,
        slider_start: 0.5,
        data: {
            screen: "rest",
        },
    }
    timeline.push(questionnaire)

    /* ----------------- HBT----------------- */
    // Instructions
    var instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus:
            "<h2>Tapping Task</h2>" +
            "<p><b>Instructions</b></p>" +
            "<p>In the following task, you will need to tap the spacebar with any rhythm you prefer.</p>" +
            "<p>Please <b>maintain the speed of tapping</b> until the first trial is over.</p>",
        choices: ["I am ready"],
    };
    timeline.push(instructions);

    // Define the question text
    var tapquestion =
        "Have you followed any stimulus while tapping (music, heartbeat, respiration, surrounding noise, etc.)?</b>"

    function createTrial() {
        var tap = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<p style="font-size:48px; color:black;">[SPACE]</p>',
            choices: [' '], // Only the spacebar option          
            extensions: extensions,
            on_load: function () {
                create_marker(marker_position);
            },
            on_finish: function (data) {
                document.querySelector("#marker").remove();
            },
        };
        timeline.push(tap);
    }

    function generateTrials(numTrials) {
        for (var i = 0; i < numTrials; i++) {
            createTrial();
        }
    }

    // Generate first trial
    generateTrials(30);

    // Add the tap question
    timeline.push({
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: tapquestion,
                placeholder: "Enter your answer here",
                name: "tap_question_1_response",
            },
        ],
        data: {
            screen: "tap1",
        },
    })

    // Insert a break
    var breakTrial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>Well done, now tap with a <b>slower</b> rhythm.</p>" +
            "<p>Please <b>maintain the speed of tapping</b> until the second trial is over.</p>" +
            "<p>Press any key to continue.</p>"
    };
    timeline.push(breakTrial);

    // Generate another trial
    generateTrials(30);

    // Add the tap question
    timeline.push({
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: tapquestion,
                placeholder: "Enter your answer here",
                name: "tap_question_2_response",
            },
        ],
        data: {
            screen: "tap2",
        },
    })

    // Insert a break
    var breakTrial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>Well done, now tap with a <b>faster</b> rhythm.</p>" +
            "<p>Please <b>maintain the speed of tapping</b> until the third trial is over.</p>" +
            "<p>Press any key to continue.</p>"
    };
    timeline.push(breakTrial);

    // Generate another trial
    generateTrials(30);

    // Add the tap question
    timeline.push({
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: tapquestion,
                placeholder: "Enter your answer here",
                name: "tap_question_3_response",
            },
        ],
        data: {
            screen: "tap3",
        },
    })

    /* ----------------- HBC ----------------- */
    // Instructions
    var instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus:
            "<h2>Heartbeat Counting Task</h2>" +
            "<p><b>Instructions</b></p>" +
            // Don't give exact time so that participants don't count
            "<p>In the following task, you will need to count and report the number of heartbeats during several intervals.</p>" +
            "<p>Simply <b>relax</b> and remain seated quietly while <b>counting your heartbeat without physically measuring it</b>.</p> " +
            "<p>The interval will start with a '3-2-1' signal, after which you need to count your heartbeats until you hear a beep.</p> " +
            "<p>Questions will then be displayed for you to answer.</p>",
        choices: ["I am ready"],
    }
    timeline.push(instructions)

    function create_marker(marker_position, color = "black") {
        const html = `<div id="marker" style="position: absolute; background-color: ${color};\
    left:${marker_position[0]}px; top:${marker_position[1]}px; \
    width:${marker_position[2]}px; height:${marker_position[3]}px";></div>`
        document
            .querySelector("body")
            .insertAdjacentHTML("beforeend", html)
    }

    // Define the question texts
    var question1 =
        "Enter how many heartbeats you counted <b>during the last trial</b>:"
    var question2 =
        "Enter how confident were you with your <b>heartbeat counting</b>:"

    // Create an array to store the trial order
    var trialOrder = []

    // Populate the trial order array
    for (let i = 0; i < duration.length; i++) {
        trialOrder.push(i)
    }

    // Shuffle the trial order
    var shuffledTrialOrder =
        jsPsych.randomization.shuffle(trialOrder)

    // Define the pause duration (in milliseconds)
    var pauseDuration = 3000 // 3 seconds

    // Iterate through the shuffled trial order
    for (let i = 0; i < shuffledTrialOrder.length; i++) {
        var trialIndex = shuffledTrialOrder[i]

        // Create blank grey screen with countdown just before each trial
        var buffer = {
            type: jsPsychHtmlKeyboardResponse,
            on_start: function () {
                document.body.style.backgroundColor = "#808080"
                document.body.style.cursor = "none"
                create_marker(marker_position, (color = "white"))
            },
            on_finish: function () {
                document.querySelector("#marker").remove()
                jsPsych.finishTrial() // Explicitly advance to the next trial
            },
            stimulus: function () {
                var count = 3
                var countdownHTML =
                    '<p style="font-size: 100px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">' +
                    count +
                    "</p>"
                var countdownInterval = setInterval(function () {
                    count--
                    if (count > 0) {
                        document.querySelector(
                            "#countdown"
                        ).innerHTML = count
                    } else {
                        clearInterval(countdownInterval)
                    }
                }, 1000) // Update countdown every second
                return (
                    '<div id="countdown" style="font-size: 100px;">' +
                    count +
                    "</div>"
                )
            },
            choices: "NO_KEYS",
            trial_duration: pauseDuration, // Pause duration before the trial starts
            css_classes: ["fixation"],
        }
        timeline.push(buffer)

        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            extensions: extensions,
            on_load: function () {
                create_marker(marker_position)
            },
            stimulus: "<p style='font-size:150px;'>+</p>",
            choices: ["s"],
            trial_duration: duration[trialIndex] * 1000,
            css_classes: ["fixation"],
            data: {
                screen: "resting",
                time_start: function () {
                    return performance.now()
                },
            },
            on_finish: function (data) {
                document.querySelector("#marker").remove()
                data.duration =
                    (performance.now() - data.time_start) /
                    1000 /
                    60
            },
        })

        // Beep after each trial
        var audio_trigger = {
            type: jsPsychAudioButtonResponse,
            on_start: function () {
                document.body.style.backgroundColor = "#FFFFFF"
                document.body.style.cursor = "auto"
            },
            stimulus: beep,
            prompt: "<p>This trial is over, please press continue.</p>",
            choices: ["Continue"],
        }
        timeline.push(audio_trigger)

        // Add the first question
        timeline.push({
            type: jsPsychSurveyText,
            questions: [
                {
                    prompt: question1,
                    placeholder: "Heartbeats counted",
                    name: "question1_response",
                },
            ],
            data: {
                screen: "hbc1",
            },
        })

        // Add the second question as jsPsychMultipleSlider
        var scale = ["Not confident at all", "Totally confident"]
        timeline.push({
            type: jsPsychMultipleSlider,
            questions: [
                {
                    prompt: question2,
                    name: "question2_response",
                    min: 0,
                    max: 100,
                    slider_start: 50,
                    ticks: scale,
                    required: true,
                },
            ],
            data: {
                screen: "hbc2",
            },
        })
    }

    /* ----------------- Start Of Other Questionnaires ----------------- */
    // Create an array to store the task order
    var taskOrder = ["IAS", "MAIA", "PI99"]

    // Shuffle the task order
    var shuffledTaskOrder = jsPsych.randomization.shuffle(taskOrder)

    // Iterate through the shuffled task order
    for (let i = 0; i < shuffledTaskOrder.length; i++) {
        var task = shuffledTaskOrder[i]

        if (task === "IAS") {
            // IAS Questions
            var scale = ["Strongly Disagree", "Strongly Agree"]
            var questions = []
            for (const [index, element] of items1.entries()) {
                questions.push({
                    prompt: "<b>" + element + "</b>",
                    name: dimensions1[index],
                    ticks: scale,
                    required: questions_required,
                })
            }

            var ias = {
                type: jsPsychMultipleSlider,
                questions: questions,
                randomize_question_order: true,
                preamble:
                    "<h2>About your body sensations...</h2>" +
                    "<p>Below are several statements regarding how accurately you can perceive specific bodily sensations. Please rate on the scale how well you believe you can perceive each specific signal.</p>" +
                    "<p>For example, if you often feel you need to urinate and then realise you do not need to when you go to the toilet you would rate your accuracy perceiving this bodily signal as low.</p>" +
                    "<p>Please only rate how well you can perceive these signals without using external cues, for example, if you can only perceive how fast your heart is beating when you measure it by taking your pulse this would not count as accurate internal perception.</p><br /><br/> ",
                require_movement: questions_required,
                slider_width: null,
                min: 0,
                max: 1,
                slider_start: 0.5,
                data: {
                    screen: "ias",
                },
            }
            timeline.push(ias)
        } else if (task === "MAIA") {
            // MAIA-2 Questions
            var scale = ["Never", "Always"]
            var questions = []
            for (const [index, element] of items2.entries()) {
                questions.push({
                    prompt: "<b>" + element + "</b>",
                    name: dimensions2[index],
                    ticks: scale,
                    required: questions_required,
                })
            }

            var maia = {
                type: jsPsychMultipleSlider,
                questions: questions,
                randomize_question_order: true,
                preamble:
                    "<h2>About your body sensations...</h2>" +
                    "<p>Please indicate how often each statement applies to you generally in daily life.</p><br /><br/> ",
                require_movement: questions_required,
                slider_width: null,
                min: 0,
                max: 1,
                slider_start: 0.5,
                data: {
                    screen: "maia",
                },
            }
            timeline.push(maia)
        } else if (task === "PI99") {
            // PI-99 Questions
            var scale = ["Strongly Disagree", "Strongly Agree"]
            var questions = []
            var questionsPerPage = 33 // Number of questions per page
            var totalPages = Math.ceil(items3.length / questionsPerPage) // Total number of pages

            for (const [index, element] of items3.entries()) {
                questions.push({
                    prompt: "<b>" + element + "</b>",
                    name: dimensions3[index],
                    ticks: scale,
                    required: questions_required,
                })

                // Check if the current page is full or if it's the last page
                if (
                    questions.length === questionsPerPage ||
                    index === items3.length - 1
                ) {
                    var pageNumber =
                        Math.floor(index / questionsPerPage) + 1 // Current page number

                    var pi99 = {
                        type: jsPsychMultipleSlider,
                        questions: questions,
                        randomize_question_order: true,
                        preamble:
                            "<h2>About the world we live in... (" +
                            pageNumber +
                            "/" +
                            totalPages +
                            ")</h2>" +
                            "<p>Below are very general statements about the world—not the world we wish we lived in, but the actual world as it is now.</p>" +
                            "<p>Please share your sense of agreement or disagreement.</p>" +
                            "<p>When in doubt, go with what initially feels true of the real world.</p>" +
                            "<p>There are no wrong answers. There is no need to overthink.</p><br /><br/> ",
                        require_movement: questions_required,
                        slider_width: null,
                        min: 0,
                        max: 1,
                        slider_start: 0.5,
                        data: {
                            screen: "pi99",
                        },
                    }
                    timeline.push(pi99)
                    questions = [] // Reset questions array for the next page
                }
            }
        }
    }

    // Debriefing and exit fullscreen
    timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: "You've reached the end of the task, thank you!",
        choices: ["Exit Fullscreen"],
        on_finish: function () {
            document.exitFullscreen()
        },
    })

    jsPsych.run(timeline)

    function clean_data() {
        if (record_webcam == true) {
            items["video"] = jsPsych.data
                .get()
                .filter({ screen: "resting" })
                .values()[0]["record_video_data"]
        }
    }

</script>

</html>
